<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursed Terminal - Permanent Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Mitr:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom Font Settings */
        .font-scary {
            font-family: 'Mitr', sans-serif; 
            letter-spacing: 0.05em;
        }
        .font-creep {
            font-family: 'Creepster', cursive;
        }

        /* Background and Scanlines */
        body {
            background-color: #000;
            overflow: hidden;
            color: #ff0033;
        }
        
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(255, 0, 51, 0.05) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100%; }
        }

        .crt-overlay {
            background: rgba(18, 16, 16, 0.1);
            background: radial-gradient(circle, rgba(32,0,0,0) 50%, rgba(0,0,0,0.8) 100%);
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 5;
            pointer-events: none;
        }

        /* === Main Red Glitch Text Effect === */
        .glitch {
            position: relative;
            color: #ff0033;
            text-shadow: 2px 2px #330000;
        }
        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
        .glitch::before {
            left: 2px;
            text-shadow: -1px 0 #00ffff;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch::after {
            left: -2px;
            text-shadow: -1px 0 #ff0033;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim {
            0% { clip: rect(36px, 9999px, 9px, 0); transform: skew(0.85deg); }
            5% { clip: rect(75px, 9999px, 54px, 0); transform: skew(0.3deg); }
            10% { clip: rect(19px, 9999px, 29px, 0); transform: skew(0.04deg); }
            15% { clip: rect(64px, 9999px, 94px, 0); transform: skew(0.76deg); }
            20% { clip: rect(52px, 9999px, 86px, 0); transform: skew(0.16deg); }
            25% { clip: rect(34px, 9999px, 12px, 0); transform: skew(0.68deg); }
            30% { clip: rect(16px, 9999px, 67px, 0); transform: skew(0.83deg); }
            35% { clip: rect(86px, 9999px, 27px, 0); transform: skew(0.13deg); }
            40% { clip: rect(29px, 9999px, 96px, 0); transform: skew(0.99deg); }
            45% { clip: rect(94px, 9999px, 42px, 0); transform: skew(0.31deg); }
            50% { clip: rect(21px, 9999px, 7px, 0); transform: skew(0.71deg); }
            55% { clip: rect(69px, 9999px, 56px, 0); transform: skew(0.15deg); }
            60% { clip: rect(4px, 9999px, 82px, 0); transform: skew(0.81deg); }
            65% { clip: rect(38px, 9999px, 31px, 0); transform: skew(0.41deg); }
            70% { clip: rect(91px, 9999px, 13px, 0); transform: skew(0.53deg); }
            75% { clip: rect(12px, 9999px, 75px, 0); transform: skew(0.06deg); }
            80% { clip: rect(57px, 9999px, 25px, 0); transform: skew(0.93deg); }
            85% { clip: rect(83px, 9999px, 91px, 0); transform: skew(0.28deg); }
            90% { clip: rect(41px, 9999px, 63px, 0); transform: skew(0.64deg); }
            95% { clip: rect(7px, 9999px, 49px, 0); transform: skew(0.37deg); }
            100% { clip: rect(53px, 9999px, 18px, 0); transform: skew(0.52deg); }
        }
        @keyframes glitch-anim2 {
            0% { clip: rect(65px, 9999px, 100px, 0); transform: skew(0.32deg); }
            100% { clip: rect(2px, 9999px, 85px, 0); transform: skew(0.66deg); }
        }

        /* === Green Success Glitch Effect === */
        .success-glitch-text {
            position: relative;
            color: #00ff00;
            text-shadow: 2px 2px 0px #003300;
            font-weight: 900;
            animation: glitch-skew 1s infinite linear alternate-reverse;
        }
        .success-glitch-text::before,
        .success-glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
        .success-glitch-text::before {
            left: -2px;
            text-shadow: -2px 0 #ffffff;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim-green 3s infinite linear alternate-reverse;
        }
        .success-glitch-text::after {
            left: 2px;
            text-shadow: -2px 0 #33ff33;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2-green 2.5s infinite linear alternate-reverse;
        }

        @keyframes glitch-skew {
            0% { transform: skew(1deg); }
            10% { transform: skew(-1deg); }
            20% { transform: skew(0.5deg); }
            30% { transform: skew(-0.5deg); }
            40% { transform: skew(0deg); }
            100% { transform: skew(0deg); }
        }
        @keyframes glitch-anim-green {
            0% { clip: rect(12px, 9999px, 75px, 0); transform: skew(0.85deg); }
            20% { clip: rect(83px, 9999px, 91px, 0); transform: skew(0.3deg); }
            40% { clip: rect(4px, 9999px, 82px, 0); transform: skew(0.04deg); }
            60% { clip: rect(52px, 9999px, 86px, 0); transform: skew(0.76deg); }
            80% { clip: rect(16px, 9999px, 67px, 0); transform: skew(0.16deg); }
            100% { clip: rect(53px, 9999px, 18px, 0); transform: skew(0.52deg); }
        }
        @keyframes glitch-anim2-green {
            0% { clip: rect(65px, 9999px, 100px, 0); transform: skew(0.32deg); }
            50% { clip: rect(38px, 9999px, 31px, 0); transform: skew(0.41deg); }
            100% { clip: rect(2px, 9999px, 85px, 0); transform: skew(0.66deg); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a0000; }
        ::-webkit-scrollbar-thumb { background: #660000; }
        ::-webkit-scrollbar-thumb:hover { background: #990000; }

        .history-item {
            border-left: 2px solid #ff0033;
            background: linear-gradient(90deg, rgba(50,0,0,0.6) 0%, rgba(0,0,0,0) 100%);
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        input:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(255, 0, 51, 0.5);
        }
    </style>
</head>
<body class="h-screen w-full relative flex items-center justify-center font-scary">

    <!-- Matrix Background Canvas -->
    <canvas id="matrix" class="absolute top-0 left-0 w-full h-full z-0"></canvas>
    
    <!-- Overlay Effects -->
    <div class="scanline"></div>
    <div class="crt-overlay"></div>

    <!-- Main Container -->
    <div class="relative z-20 w-full max-w-md p-6 mx-4 border border-red-900 bg-black/80 backdrop-blur-sm shadow-[0_0_50px_rgba(255,0,0,0.2)] rounded-sm">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-2 glitch" data-text="ฉันจะทำตามทุกสิ่งที่คุณขอเอง">
                ฉันจะทำตามทุกสิ่งที่คุณขอเอง
            </h1>
            <p class="text-red-800 text-xs tracking-[0.3em] uppercase mt-2">System: CONNECTED_TO_HIVE_MIND</p>
        </div>

        <!-- Input Section -->
        <div class="space-y-4">
            <div class="relative group">
                <input type="text" id="requestInput" 
                    class="w-full bg-black border-b-2 border-red-800 text-red-500 px-4 py-3 focus:border-red-500 transition-colors placeholder-red-900/50 font-mono"
                    placeholder="พิมพ์คำขอของคุณที่นี่..." autocomplete="off">
                <div class="absolute right-2 top-3 text-red-900/50 pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </div>
            </div>

            <button id="submitBtn" onclick="handleRequest()" 
                class="w-full bg-red-900/20 hover:bg-red-900/40 border border-red-800 text-red-500 py-3 px-4 uppercase tracking-widest text-sm font-bold transition-all duration-300 hover:shadow-[0_0_15px_rgba(255,0,0,0.4)] hover:text-red-300 group relative overflow-hidden">
                <span class="relative z-10">ร้องขอ (REQUEST)</span>
                <div class="absolute inset-0 h-full w-full bg-red-800/20 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-500"></div>
            </button>
        </div>

        <!-- History Section -->
        <div class="mt-10">
            <div class="flex justify-between items-end mb-3 border-b border-red-900/30 pb-1">
                <h2 class="text-red-900 text-xs uppercase tracking-widest">ประวัติสัญญา (History)</h2>
                <button onclick="clearAllHistory()" class="text-[10px] text-red-900 hover:text-red-500 uppercase tracking-widest transition-colors border border-red-900/50 px-2 py-0.5 hover:bg-red-900/20">
                    ลบทั้งหมด (CLEAR ALL)
                </button>
            </div>
            <div id="historyList" class="space-y-2 max-h-40 overflow-y-auto pr-2 font-mono text-sm">
                <!-- History items will appear here -->
                <div id="emptyMsg" class="text-red-900/40 text-xs italic text-center py-4 select-none animate-pulse">
                    เชื่อมต่อฐานข้อมูล...
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center hidden">
        <div class="text-red-600 text-4xl font-bold mb-4 glitch" data-text="กำลังร้องขอ...">
            กำลังร้องขอ...
        </div>
        <div class="w-64 h-1 bg-red-900/30 rounded overflow-hidden">
            <div class="h-full bg-red-600 animate-progress shadow-[0_0_10px_#ff0000]"></div>
        </div>
        <div id="randomCode" class="mt-4 text-red-800 font-mono text-xs font-creep tracking-widest opacity-50">
            01010101
        </div>
    </div>

    <!-- Success Modal (Green Glitch Version) -->
    <div id="successModal" class="fixed inset-0 z-50 bg-black/90 flex items-center justify-center hidden transition-opacity duration-500">
        <div class="text-center transform scale-110 border border-green-800 p-10 bg-black">
            <h2 class="text-5xl md:text-6xl font-bold mb-2 success-glitch-text" data-text="ร้องขอเสร็จสิ้น">ร้องขอเสร็จสิ้น</h2>
            <p class="text-green-600 text-sm mt-4 tracking-[0.2em] uppercase font-bold">ข้อตกลงได้รับการอนุมัติ</p>
            <div class="mt-6 text-green-800 font-mono text-xs">STATUS: PERMANENTLY_RECORDED</div>
        </div>
    </div>

    <style>
        @keyframes progress {
            0% { width: 0%; }
            30% { width: 10%; }
            50% { width: 60%; }
            80% { width: 80%; }
            100% { width: 100%; }
        }
    </style>

    <script type="module">
        // --- Firebase Setup (For Persistence) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase (This allows data to survive refresh)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUserId = null;
        let isAuthReady = false;

        // 1. Auth Logic
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                // Use custom token if available (rare in preview, but good practice)
                const { signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                // Fallback to anonymous sign-in
                await signInAnonymously(auth);
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                isAuthReady = true;
                loadHistory(); // Start loading data once we know who the user is
            }
        });

        // 2. Data Logic
        function getCollectionRef() {
            if (!currentUserId) return null;
            return collection(db, 'artifacts', appId, 'users', currentUserId, 'requests');
        }

        function loadHistory() {
            const colRef = getCollectionRef();
            if (!colRef) return;

            // Listen to real-time updates
            onSnapshot(colRef, (snapshot) => {
                const items = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    items.push({
                        id: doc.id,
                        text: data.text,
                        // Handle null timestamp (can happen immediately after write)
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date()
                    });
                });

                // Sort by time descending (newest first)
                items.sort((a, b) => b.timestamp - a.timestamp);

                renderHistory(items);
            }, (error) => {
                console.error("Error loading history:", error);
                document.getElementById('emptyMsg').innerText = "Error loading database...";
            });
        }

        // --- UI & Game Logic ---
        const input = document.getElementById('requestInput');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const successModal = document.getElementById('successModal');
        const historyList = document.getElementById('historyList');
        const randomCodeEl = document.getElementById('randomCode');
        const emptyMsg = document.getElementById('emptyMsg');
        let isRequesting = false;

        // Render the list
        function renderHistory(items) {
            historyList.innerHTML = '';
            
            if (items.length === 0) {
                emptyMsg.style.display = 'block';
                emptyMsg.innerText = 'ยังไม่มีการร้องขอ...';
                historyList.appendChild(emptyMsg);
                return;
            }
            emptyMsg.style.display = 'none';

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = "history-item p-2 text-red-400 hover:bg-red-900/10 transition-colors flex justify-between items-center group/item";
                
                const timeStr = `${String(item.timestamp.getHours()).padStart(2,'0')}:${String(item.timestamp.getMinutes()).padStart(2,'0')}`;
                
                div.innerHTML = `
                    <div class="break-all mr-2 flex-1">
                        <span class="text-red-800 text-xs mr-2 font-bold">[${timeStr}]</span>
                        <span>${item.text}</span>
                    </div>
                    <button onclick="window.deleteItem('${item.id}')" class="text-red-900 hover:text-red-500 px-2 font-bold opacity-0 group-hover/item:opacity-100 transition-opacity" title="ลบ">
                        X
                    </button>
                `;
                historyList.appendChild(div);
            });
        }

        // Handle Request
        window.handleRequest = async function() {
            const text = input.value.trim();
            if (!text || !isAuthReady) return;

            isRequesting = true;
            loadingOverlay.classList.remove('hidden');
            
            try {
                // Save to Firestore
                await addDoc(getCollectionRef(), {
                    text: text,
                    timestamp: serverTimestamp()
                });
                
                // Success Animation
                finishRequest();
                input.value = "";
            } catch (e) {
                console.error(e);
                alert("Failed to save data.");
                isRequesting = false;
                loadingOverlay.classList.add('hidden');
            }
        }

        function finishRequest() {
            isRequesting = false;
            loadingOverlay.classList.add('hidden');
            successModal.classList.remove('hidden');
            setTimeout(() => {
                successModal.classList.add('hidden');
            }, 2500);
        }

        // Delete Item
        window.deleteItem = async function(id) {
            if (!isAuthReady) return;
            const colRef = getCollectionRef();
            await deleteDoc(doc(colRef, id));
        }

        // Clear All
        window.clearAllHistory = async function() {
            if (!isAuthReady) return;
            if (!confirm("ลบประวัติทั้งหมด? (กู้คืนไม่ได้)")) return;

            const colRef = getCollectionRef();
            const snapshot = await getDocs(colRef);
            const batch = writeBatch(db);
            
            snapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        }

        // --- Visual Effects (Matrix) ---
        const creepChars = "01X†ΨΩ";
        setInterval(() => {
            if(isRequesting) {
                let code = "";
                for(let i=0; i<20; i++) {
                    code += creepChars.charAt(Math.floor(Math.random() * creepChars.length));
                }
                randomCodeEl.innerText = code;
            }
        }, 100);

        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                window.handleRequest();
            }
        });

        const canvas = document.getElementById('matrix');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        const binary = "01";
        const fontSize = 16;
        let columns = Math.floor(canvas.width / fontSize);
        const drops = [];
        for (let x = 0; x < columns; x++) drops[x] = 1;

        function drawMatrix() {
            ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#800000"; 
            ctx.font = fontSize + "px monospace";

            for (let i = 0; i < drops.length; i++) {
                const text = binary.charAt(Math.floor(Math.random() * binary.length));
                if(Math.random() > 0.95) ctx.fillStyle = "#ff0000"; 
                else ctx.fillStyle = "#800000"; 
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        setInterval(drawMatrix, 35);

    </script>
</body>
</html>
